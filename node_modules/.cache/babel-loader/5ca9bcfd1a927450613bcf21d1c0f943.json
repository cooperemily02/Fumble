{"ast":null,"code":"var pager = require('memory-pager');\n\nmodule.exports = Bitfield;\n\nfunction Bitfield(opts) {\n  if (!(this instanceof Bitfield)) return new Bitfield(opts);\n  if (!opts) opts = {};\n  if (Buffer.isBuffer(opts)) opts = {\n    buffer: opts\n  };\n  this.pageOffset = opts.pageOffset || 0;\n  this.pageSize = opts.pageSize || 1024;\n  this.pages = opts.pages || pager(this.pageSize);\n  this.byteLength = this.pages.length * this.pageSize;\n  this.length = 8 * this.byteLength;\n  if (!powerOfTwo(this.pageSize)) throw new Error('The page size should be a power of two');\n  this._trackUpdates = !!opts.trackUpdates;\n  this._pageMask = this.pageSize - 1;\n\n  if (opts.buffer) {\n    for (var i = 0; i < opts.buffer.length; i += this.pageSize) {\n      this.pages.set(i / this.pageSize, opts.buffer.slice(i, i + this.pageSize));\n    }\n\n    this.byteLength = opts.buffer.length;\n    this.length = 8 * this.byteLength;\n  }\n}\n\nBitfield.prototype.get = function (i) {\n  var o = i & 7;\n  var j = (i - o) / 8;\n  return !!(this.getByte(j) & 128 >> o);\n};\n\nBitfield.prototype.getByte = function (i) {\n  var o = i & this._pageMask;\n  var j = (i - o) / this.pageSize;\n  var page = this.pages.get(j, true);\n  return page ? page.buffer[o + this.pageOffset] : 0;\n};\n\nBitfield.prototype.set = function (i, v) {\n  var o = i & 7;\n  var j = (i - o) / 8;\n  var b = this.getByte(j);\n  return this.setByte(j, v ? b | 128 >> o : b & (255 ^ 128 >> o));\n};\n\nBitfield.prototype.toBuffer = function () {\n  var all = alloc(this.pages.length * this.pageSize);\n\n  for (var i = 0; i < this.pages.length; i++) {\n    var next = this.pages.get(i, true);\n    var allOffset = i * this.pageSize;\n    if (next) next.buffer.copy(all, allOffset, this.pageOffset, this.pageOffset + this.pageSize);\n  }\n\n  return all;\n};\n\nBitfield.prototype.setByte = function (i, b) {\n  var o = i & this._pageMask;\n  var j = (i - o) / this.pageSize;\n  var page = this.pages.get(j, false);\n  o += this.pageOffset;\n  if (page.buffer[o] === b) return false;\n  page.buffer[o] = b;\n\n  if (i >= this.byteLength) {\n    this.byteLength = i + 1;\n    this.length = this.byteLength * 8;\n  }\n\n  if (this._trackUpdates) this.pages.updated(page);\n  return true;\n};\n\nfunction alloc(n) {\n  if (Buffer.alloc) return Buffer.alloc(n);\n  var b = new Buffer(n);\n  b.fill(0);\n  return b;\n}\n\nfunction powerOfTwo(x) {\n  return !(x & x - 1);\n}","map":null,"metadata":{},"sourceType":"script"}